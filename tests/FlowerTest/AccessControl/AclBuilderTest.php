<?php
namespace FlowerTest\AccessControl;

use Flower\AccessControl\AclBuilder;
use Flower\Test\TestTool;
use Zend\Permissions\Acl\Acl as ZendAcl;

/**
 * Generated by PHPUnit_SkeletonGenerator on 2015-02-25 at 08:58:05.
 */
class AclBuilderTest extends \PHPUnit_Framework_TestCase
{
    /**
     * @var AclBuilder
     */
    protected $object;

    /**
     * Sets up the fixture, for example, opens a network connection.
     * This method is called before a test is executed.
     */
    protected function setUp()
    {
        $this->object = new AclBuilder;
    }

    /**
     * Tears down the fixture, for example, closes a network connection.
     * This method is called after a test is executed.
     */
    protected function tearDown()
    {
    }

    /**
     * @covers Flower\AccessControl\AclBuilder::setAcl
     */
    public function testSetAcl()
    {
        $acl = $this->getMock('Zend\\Permissions\\Acl\\Acl');
        $this->object->setAcl($acl);
        $this->assertSame($acl, TestTool::getPropertyValue($this->object, 'acl'));
    }

    /**
     * @covers Flower\AccessControl\AclBuilder::setGenericRoles
     */
    public function testSetGenericRoles()
    {
        $expects = array('foo' => 'bar');
        $this->object->setGenericRoles($expects);
        $this->assertEquals($expects, TestTool::getPropertyValue($this->object, 'genericRoles'));
    }

    /**
     * @covers Flower\AccessControl\AclBuilder::setGenericResources
     */
    public function testSetGenericResources()
    {
        $expects = array('foo' => 'bar');
        $this->object->setGenericResources($expects);
        $this->assertEquals($expects, TestTool::getPropertyValue($this->object, 'genericResources'));
    }

    /**
     * @covers Flower\AccessControl\AclBuilder::setGenericRules
     */
    public function testSetGenericRules()
    {
        $expects = array('foo' => 'bar');
        $this->object->setGenericRules($expects);
        $this->assertEquals($expects, TestTool::getPropertyValue($this->object, 'genericRules'));
    }


    /**
     * @covers Flower\AccessControl\AclBuilder::setGenerics
     */
    public function testSetGenerics()
    {
        $roles = array('foo' => 1);
        $resources = array('baz' => 2);
        $rules = array('bar' => 3);
        $this->object->setGenerics($roles, $resources, $rules);
        $this->assertEquals($roles, TestTool::getPropertyValue($this->object, 'genericRoles'));
        $this->assertEquals($rules, TestTool::getPropertyValue($this->object, 'genericRules'));
        $this->assertEquals($resources, TestTool::getPropertyValue($this->object, 'genericResources'));
    }

    /**
     * @covers Flower\AccessControl\AclBuilder::addResources
     */
    public function testAddResources()
    {
        $resources = array(
            'document',
            'compe',
            /**
             * プロパティ内継承
             * リソース名のドットがプロパティとかぶっている点に注意を要する。
             * foo.bar プロパティのcompeリソースは
             * fooプロパティの bar.compe リソースとシステム上で区別されない。
             *
             * ただし、fooプロパティの所有者は、barリソースと下位foo.barプロパティを同時には持たないから
             * 上位プロパティの管理者がオカシナことをしなければ問題は生じない。
             * つまり、プロパティとリソースはリソースクラス内のコンポジットパターンになっている点に留意すること。
             */
            'compe.score' => 'compe',
        );
        $expects = Array (
            'foo.compe',
            'foo',
            'foo.bar',
            'foo.bar.document',
            'foo.bar.compe',
            'foo.bar.compe.score',
            'foo.school',
            'foo.bar.school',
            'foo.document',
        );
        $property = 'foo.bar';
        $acl = new ZendAcl;
        $this->object->setAcl($acl);
        /**
         * 事前にparentリソースを登録しておくと、親プロパティのリソースを継承して登録します。
         * 後付では継承されない点に注意してください。
         */
        $acl->addResource('foo.compe');
        $this->object->addResources($resources, $property);
        //垂直継承
        $acl->addResource('foo.school', 'foo');
        //foo.bar.schoolをfoo.schoolを継承して追加したい。
        $this->object->addResources(array('school'), $property, true);

        //垂直継承の指定によるリソース追加だが、事前に水平継承されているので垂直継承の指定は無視されます。
        $acl->addResource('foo.document', 'foo');
        $this->object->addResources(array('document'), $property, true);

        $this->assertEquals($expects, $acl->getResources());

        $this->assertTrue($acl->inheritsResource('foo.bar.compe', 'foo.bar'));
        $this->assertTrue($acl->inheritsResource('foo.bar.compe.score', 'foo.bar.compe'));
        $this->assertTrue($acl->inheritsResource('foo.bar.school', 'foo.school'));
        $this->assertFalse($acl->inheritsResource('foo.bar.document', 'foo.document'));
    }

    /**
     * @covers Flower\AccessControl\AclBuilder::addRoles
     */
    public function testAddRoles()
    {
        $roles = array(
            'guest',
            'staff',
            'compe_admin' => array('/guest', 'staff'),
            'writer' => 'staff',
            'owner' => 'staff', //ownerはadminを指定できる、granter　しかし、誤操作を防ぐため他の権限は不要
            'admin' => 'staff',
        );
        $property = 'foo.bar';
        $acl = new ZendAcl;

        /**
         * guestはグローバルを継承するように、/guestという指定になっている。
         * 原理的に、/adminを継承するように設定すれば、全権を取れるから、
         * プロパティの管理者に権限付与を許可する場合は、指定内容に注意すること。
         */
        $acl->addRole('guest');
        $this->object->setAcl($acl);
        $this->object->addRoles($roles, $property);
        $this->assertContains('foo.bar.admin', $acl->getRoles());
    }

    /**
     * @covers Flower\AccessControl\AclBuilder::addRoles
     * @expectedException Zend\Permissions\Acl\Exception\InvalidArgumentException
     */
    public function testAddRolesWithMissingParents()
    {
        $roles = array(
            'admin' => array('staff', 'writer'),
        );
        $property = 'foo.bar';
        $acl = new ZendAcl;
        $this->object->setAcl($acl);
        $this->object->addRoles($roles, $property);
    }

    /**
     * @covers Flower\AccessControl\AclBuilder::addRules
     */
    public function testAddRules()
    {
        $acl = new ZendAcl;
        $allow = ZendAcl::TYPE_ALLOW;
        $deny = ZendAcl::TYPE_DENY;
        $property = 'foo.bar';
        $resources = array(
            'document',
            'comment',
        );
        $roles = array(
            'staff',
            'writer',
            'admin' => array('staff', 'writer'),
        );
        $rules = array(
            'writer' => array($allow, 'writer', 'document', array('create', 'update', 'post', 'post_as', 'push_file', 'push_image')),
            'admin' => array($allow, 'admin', null, null), //リソースは限定するべきですね。
        );

        $this->object->setAcl($acl);
        $this->object->addRoles($roles, $property);
        $this->object->addResources($resources, $property);
        $this->object->addRules($rules, $property);

        $pRules = TestTool::getPropertyValue($acl, 'rules');

        $this->assertTrue($acl->isAllowed('foo.bar.writer', 'foo.bar.document', 'create'));
        $this->assertFalse($acl->isAllowed('foo.bar.writer', null, 'create'));
        $this->assertFalse($acl->isAllowed('foo.bar.admin', null, null));
    }

    /**
     * @covers Flower\AccessControl\AclBuilder::build
     */
    public function testBuild()
    {
        $this->markTestSkipped(
          'buildはaddRoles addResources addRulesへの仲介を行うのみなのでテストを省略中。必要に応じて追加してください。'
        );
    }
}
